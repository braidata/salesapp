// /**
//  * // 20230322151043
// // https://test-ventus-sales.ventuscorp.cl/api/ordersVentus?id=175887&rut=13069905-7&name=Rodrigo%20Gonzalez&mode=put

// {
//   "id": 175887,
//   "parent_id": 0,
//   "status": "on-hold",
//   "currency": "CLP",
//   "version": "7.5.0",
//   "prices_include_tax": false,
//   "date_created": "2023-03-22T14:39:32",
//   "date_modified": "2023-03-22T14:39:32",
//   "discount_total": "0",
//   "discount_tax": "0",
//   "shipping_total": "0",
//   "shipping_tax": "0",
//   "cart_tax": "0",
//   "total": "449990",
//   "total_tax": "0",
//   "customer_id": 0,
//   "order_key": "wc_order_rDKDGI4jq8P08",
//   "billing": {
//     "first_name": "LOCALES Y COMERCIO",
//     "last_name": "BLF DOS SPA",
//     "company": "",
//     "address_1": "matias cousio",
//     "address_2": "",
//     "city": "METROPOLITANA",
//     "state": "43",
//     "postcode": "",
//     "country": "CL",
//     "email": "contacto@binomiosbar.cl",
//     "phone": "+56 9 9545 4720"
//   },
//   "shipping": {
//     "first_name": "LOCALES Y COMERCIO",
//     "last_name": "BLF DOS SPA",
//     "company": "",
//     "address_1": "matias cousio",
//     "address_2": "",
//     "city": "METROPOLITANA",
//     "state": "43",
//     "postcode": "",
//     "country": "CL",
//     "phone": ""
//   },
//   "payment_method": "bacs",
//   "payment_method_title": "Transferencia Bancaria",
//   "transaction_id": "",
//   "customer_ip_address": "200.27.40.226",
//   "customer_user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36 Edg/111.0.1661.41",
//   "created_via": "checkout",
//   "customer_note": "",
//   "date_completed": null,
//   "date_paid": null,
//   "cart_hash": "8712d83f015627acc236b4370fe4d7c9",
//   "number": "175887",
//   "meta_data": [
//     {
//       "id": 6901247,
//       "key": "_billing_documento",
//       "value": "factura"
//     },
//     {
//       "id": 6901248,
//       "key": "_billing_fijo",
//       "value": ""
//     },
//     {
//       "id": 6901249,
//       "key": "_billing_rut",
//       "value": "77328906-9"
//     },
//     {
//       "id": 6901250,
//       "key": "_billing_RUT_Empresa",
//       "value": "77328906-9"
//     },
//     {
//       "id": 6901251,
//       "key": "_billing_giro",
//       "value": "cafeteria"
//     },
//     {
//       "id": 6901252,
//       "key": "_billing_razon_social",
//       "value": "LOCALES Y COMERCIO BLF DOS SPA"
//     },
//     {
//       "id": 6901253,
//       "key": "_billing_Nombre_de_fantasia",
//       "value": "LOCALES Y COMERCIO BLF DOS SPA"
//     },
//     {
//       "id": 6901254,
//       "key": "_billing_comuna",
//       "value": "SANTIAGO CENTRO"
//     },
//     {
//       "id": 6901255,
//       "key": "_billing_Numero_Direccion",
//       "value": "119"
//     },
//     {
//       "id": 6901256,
//       "key": "_billing_Numero_dpto",
//       "value": ""
//     },
//     {
//       "id": 6901257,
//       "key": "_shipping_comuna",
//       "value": "SANTIAGO CENTRO"
//     },
//     {
//       "id": 6901258,
//       "key": "_shipping_Numero_Direccion",
//       "value": "119"
//     },
//     {
//       "id": 6901259,
//       "key": "_shipping_Numero_dpto",
//       "value": ""
//     },
//     {
//       "id": 6901260,
//       "key": "is_vat_exempt",
//       "value": "no"
//     },
//     {
//       "id": 6901261,
//       "key": "RUT",
//       "value": "77328906-9"
//     },
//     {
//       "id": 6901263,
//       "key": "_ga_tracked",
//       "value": "1"
//     },
//     {
//       "id": 6901395,
//       "key": "_retiro_local_rut",
//       "value": "13069905-7"
//     },
//     {
//       "id": 6901396,
//       "key": "_retiro_local_name",
//       "value": "Rodrigo Gonzalez"
//     },
//     {
//       "id": 6901397,
//       "key": "_retiro_local_date",
//       "value": "24-03-2023"
//     },
//     {
//       "id": 6901398,
//       "key": "hubwoo_pro_guest_order",
//       "value": "yes"
//     }
//   ],
//   "line_items": [
//     {
//       "id": 186095,
//       "name": "Horno Convector Eléctrico VHC1A",
//       "product_id": 28430,
//       "variation_id": 0,
//       "quantity": 1,
//       "tax_class": "",
//       "subtotal": "449990",
//       "subtotal_tax": "0",
//       "total": "449990",
//       "total_tax": "0",
//       "taxes": [

//       ],
//       "meta_data": [
//         {
//           "id": 1609449,
//           "key": "_regular_price",
//           "value": "471990",
//           "display_key": "_regular_price",
//           "display_value": "471990"
//         },
//         {
//           "id": 1609456,
//           "key": "_reduced_stock",
//           "value": "1",
//           "display_key": "_reduced_stock",
//           "display_value": "1"
//         }
//       ],
//       "sku": "100873",
//       "price": 449990,
//       "image": {
//         "id": "61198",
//         "src": "https://ventuscorp.cl/wp-content/uploads/2019/10/Horno-Convector-Eléctrico-VHC-1A-1.jpg"
//       },
//       "parent_name": null,
//       "composite_parent": "",
//       "composite_children": [

//       ],
//       "bundled_by": "",
//       "bundled_item_title": "",
//       "bundled_items": [

//       ]
//     }
//   ],
//   "tax_lines": [

//   ],
//   "shipping_lines": [
//     {
//       "id": 186096,
//       "method_title": "Envío gratuito",
//       "method_id": "free_shipping",
//       "instance_id": "33",
//       "total": "0",
//       "total_tax": "0",
//       "taxes": [

//       ],
//       "meta_data": [
//         {
//           "id": 1609455,
//           "key": "Artículos",
//           "value": "Horno Convector Eléctrico VHC1A &times; 1",
//           "display_key": "Artículos",
//           "display_value": "Horno Convector Eléctrico VHC1A &times; 1"
//         }
//       ]
//     }
//   ],
//   "fee_lines": [

//   ],
//   "coupon_lines": [

//   ],
//   "refunds": [

//   ],
//   "payment_url": "https://ventuscorp.cl/procesar-compra/order-pay/175887/?pay_for_order=true&key=wc_order_rDKDGI4jq8P08",
//   "is_editable": true,
//   "needs_payment": false,
//   "needs_processing": true,
//   "date_created_gmt": "2023-03-22T17:39:32",
//   "date_modified_gmt": "2023-03-22T17:39:32",
//   "date_completed_gmt": null,
//   "date_paid_gmt": null,
//   "currency_symbol": "$",
//   "_links": {
//     "self": [
//       {
//         "href": "https://ventuscorp.cl/wp-json/wc/v3/orders/175887"
//       }
//     ],
//     "collection": [
//       {
//         "href": "https://ventuscorp.cl/wp-json/wc/v3/orders"
//       }
//     ]
//   }
// }
//  */

// import { useState } from "react";

// const SelectComponent = () => {
//   const [metadata, setMetadata] = useState(false);
//   const [selectedKey, setSelectedKey] = useState("");
//   const [placeholder, setPlaceholder] = useState("");

//   const keys = [
//     { key: "id", placeholder: "Ejemplo: 175887" },
//     { key: "status", placeholder: "Ejemplo: on-hold" },
//     { key: "date_created", placeholder: "Ejemplo: 2023-03-22T17:39:32" },
//     { key: "date_modified", placeholder: "Ejemplo: 2023-03-22T17:39:32" },
//     { key: "date_completed", placeholder: "Ejemplo: 2023-03-22T17:39:32" },
//     { key: "date_paid", placeholder: "Ejemplo: 2023-03-22T17:39:32" },
//     { key: "total", placeholder: "Ejemplo: 449990" },
//     { key: "total_tax", placeholder: "Ejemplo: 0" },
//     { key: "currency", placeholder: "Ejemplo: CLP" },
//     { key: "payment_method", placeholder: "Ejemplo: cash" },
//     { key: "payment_method_title", placeholder: "Ejemplo: Efectivo" },
//     { key: "transaction_id", placeholder: "Ejemplo: 175887" },
//     { key: "customer_id", placeholder: "Ejemplo: 0" },


//     // Agrega aquí todas las keys que deseas mostrar en el segundo select
//   ];

//   const handleMetadataChange = (e) => {
//     setMetadata(e.target.value === "true");
//   };

//   const handleKeyChange = (e) => {
//     const key = e.target.value;
//     setSelectedKey(key);
//     const selected = keys.find((k) => k.key === key);
//     setPlaceholder(selected?.placeholder || "");
//   };

//   return (
//     <div className="p-4">
//       <select
//         className="border rounded p-2 mr-4"
//         value={metadata}
//         onChange={handleMetadataChange}
//       >
//         <option value="false">No Metadata</option>
//         <option value="true">Metadata</option>
//       </select>
//       <select
//         className="border rounded p-2 mr-4"
//         value={selectedKey}
//         onChange={handleKeyChange}
//       >
//         <option value="">Selecciona una key</option>
//         {keys.map((k, i) => (
//           <option key={i} value={k.key}>
//             {k.key}
//           </option>
//         ))}
//       </select>
//       <input
//         className="border rounded p-2"
//         type="text"
//         placeholder={placeholder}
//       />
//     </div>
//   );
// };

// export default SelectComponent;














import { useState, useEffect } from "react";
//import set lodash
import set from 'lodash/set';
import { useSession } from "next-auth/react";

const SelectComponent = () => {
  const [metadata, setMetadata] = useState(false);
  const [selectedKey, setSelectedKey] = useState("");
  const [placeholder, setPlaceholder] = useState("");
  const [mode, setMode] = useState("get");
  const [store, setStore] = useState("Ventus");
  const [orderData, setOrderData] = useState(null);
  const [showTable, setShowTable] = useState(false);
  const [filteredOrderData, setFilteredOrderData] = useState(null);
  const { data: session } = useSession();
  let keys = [];

  const toggleTable = () => {
    setShowTable((prev) => !prev);
  };

  keys = [
    {
      key: "payment_method",
      placeholder: "Ejemplo: bacs"
    },
    {
      key: "payment_method_title",
      placeholder: "Ejemplo: Transferencia Bancaria"
    },
    {
      key: "meta_data._billing_rut",
      placeholder: "Ejemplo: 77328906-9"
    },
    {
      key: "meta_data._billing_RUT_Empresa",
      placeholder: "Ejemplo: 77328906-9"
    },
    {
      key: "billing.address_1",
      placeholder: "Dirección: El Copihue"
    },
    {
      key: "billing.address_2",
      placeholder: "Número de Dirección: 3458 Casa 4"
    },
    {
      key: "meta_data._billing_Numero_Direccion",
      placeholder: "Número de Dirección: 3458 Casa 4"
    },
    {
      key: "meta_data._billing_Numero_dpto",
      placeholder: "Número de Dirección: 3458 Casa 4"
    },
    {
      key: "shipping.address_1",
      placeholder: "Dirección: El Copihue"
    },
    {
      key: "shipping.address_2",
      placeholder: "Número de Dirección: 3458 Casa 4"
    },
    {
      key: "meta_data._shipping_Numero_Direccion",
      placeholder: "Número de Dirección: 3458 Casa 4"
    },
    {
      key: "meta_data._shipping_Numero_dpto",
      placeholder: "Número de Dirección: 3458 Casa 4"
    },
    {
      key: "customer_note",
      placeholder: "Observación: Hay un gato en la moto"
    },
    {
      key: "meta_data.authorizationCode",
      placeholder: "Ejemplo: 148273202827"
    }

  ];

  const [sessionInfo, setSessionInfo] = useState();

  useEffect(() => {
    const fetchPermisos = async () => {
      const res = await fetch("/api/mysqlPerm", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          email: session ? session.session.user.email : null,
        }),
      });
      const data = await res.json();
      console.log("el permisos: ", data.user[0].rol);
      const userRol = data ? data.user[0].permissions : "No conectado";
      console.log("el permisos2: ", data.user[0].permissions);
      setSessionInfo(userRol);
    };

    fetchPermisos();
  }, [session]);

  const getNestedValue = (obj, key) => {
    if (key.startsWith("meta_data.")) {
      const metaDataKey = key.slice(10);
      const metaData = obj.meta_data.find((item) => item.key === metaDataKey);
      return metaData ? metaData.value : null;
    } else if (key.startsWith("shipping_lines.")) {
      const shippingLinesKey = key.slice(15);
      const shippingLines = obj.shipping_lines[0];
      return shippingLines ? shippingLines[shippingLinesKey] : null;
    } else {
      return key.split('.').reduce((o, k) => (o && o[k] !== undefined ? o[k] : null), obj);
    }
  };

  const cleanNestedKeys = (data, key) => {
    let cleanedKey = key;

    if (cleanedKey.startsWith("meta_data.")) {
      cleanedKey = cleanedKey.slice(10);
    } else if (cleanedKey.startsWith("shipping_lines.")) {
      cleanedKey = cleanedKey.slice(15);
    }

    if (cleanedKey.indexOf(".") > -1) {
      const parts = cleanedKey.split(".");
      parts.shift();
      cleanedKey = parts.join(".");
    }

    const keys = cleanedKey.split(".");
    let value = data;
    for (const k of keys) {
      if (value && value[k]) {
        value = value[k];
      } else {
        value = null;
        break;
      }
    }

    return value;
  };

  const handleKeyChange = (e) => {
    const key = e.target.value;
    setSelectedKey(key);
    const selected = keys.find((k) => k.key === key);
    if (selected.key.startsWith("meta_data.")) {
      setPlaceholder("Ejemplo: " + JSON.stringify({ id: 123456, key: selected.key, value: selected.placeholder }));
    } else {
      setPlaceholder(selected?.placeholder || "");
    }
  };

  const handleStoreChange = (e) => {
    setStore(e.target.value);
    console.log("TIENDA: ", store);
  };

  const handleModeChange = (e) => {
    setMode(e.target.value);
    console.log("MODO: ", mode);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    const id = e.target.id.value;
    const key = e.target.key ? e.target.key.value : selectedKey;
    const value = e.target.value ? e.target.value.value : null;

    const metaDataKey = key.startsWith("meta_data.") ? key.slice(10) : key;

    let updatedData = {};
    if (metaDataKey.startsWith("_")) {
      updatedData.meta_data = [
        {
          key: metaDataKey,
          value,
        },
      ];
    } else {
      const keyParts = metaDataKey.split(".");
      const recursiveUpdate = (obj, parts, value) => {
        const currentKey = parts.shift();
        if (parts.length === 0) {
          obj[currentKey] = value;
        } else {
          if (!obj[currentKey]) {
            obj[currentKey] = {};
          }
          recursiveUpdate(obj[currentKey], parts, value);
        }
      };
      recursiveUpdate(updatedData, keyParts, value);
    }

    set(updatedData, key, value);

    try {
      const response = await fetch(`/api/ordersVentus`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ id, updatedData, mode, store, user: session.session.user.name }),
      });

      const data = await response.json();
      console.log(data);
      console.log("Data keys:", Object.keys(data));
      console.log("Keys:", keys.map((k) => k.key));

      const objeto = keys
        .filter((k) => getNestedValue(data, k.key) !== null)
        .reduce((obj, k) => {
          obj[k.key] = getNestedValue(data, k.key);
          return obj;
        }, {});

      setFilteredOrderData(objeto);
      console.log("OBJETO: ", filteredOrderData);

      setShowTable(true);

      return data;
    } catch (error) {
      // Handle fetch errors here
      //console.log(error);
    }
  };

  return (
    <>
      {sessionInfo === "ecommerce" || sessionInfo === "all" ? (
        <div className="max-w-sm p-2 mt-8 ml-4">
          <h1 className="dark:text-gray-300 font-bold py-2 px-4 rounded-lg hover:text-gray-900 border-gray-400 hover:bg-gray-600/50 text-gray-900 dark:bg-gradient-to-r dark:from-gray-400/80 dark:via-gray-600 dark:to-purple-200/50 border-2 dark:border-sky-200 dark:hover:bg-sky-900 hover:animate-pulse transform hover:-translate-y-1 hover:scale-110 mt-2 mb-5 bg-gradient-to-r from-gray-200 via-gray-100 to-purple-300/30 text-center transition duration-500 ease-in-out transform hover:-translate-y-1 hover:scale-110 border-2 drop-shadow-[0_10px_10px_rgba(10,15,17,0.75)] dark:drop-shadow-[0_10px_10px_rgba(255,255,255,0.25)]">
            Editor de Pedidos Woocommerce
          </h1>

          <form onSubmit={handleSubmit} >
            <div className="w-full flex flex-col justify-center gap-4">
              <label htmlFor="id" className="sr-only">ID</label>
              <input
                className="border rounded p-2 w-full"
                type="text"
                name="id"
                placeholder="ID"
              />

              <label htmlFor="store" className="sr-only">Tienda</label>
              <select
                className="border rounded p-2 w-full"
                name="store"
                value={store}
                onChange={handleStoreChange}
              >
                <option value="Ventus">VENTUS</option>
                <option value="BLK">BLANIK</option>
                <option value="BBQ">BBQGRILL</option>
              </select>

              <label htmlFor="mode" className="sr-only">Modo</label>
              <select
                className="border rounded p-2 w-full"
                name="mode"
                value={mode}
                onChange={handleModeChange}
              >
                <option value="put">EDITAR</option>
                <option value="get">VER</option>
              </select>

              <label htmlFor="key" className="sr-only">Seleccionar clave</label>
              <select
                className="border rounded p-2 w-full"
                name="key"
                value={selectedKey}
                onChange={handleKeyChange}
              >
                <option value="">Seleccionar clave</option>
                {keys.map((key) => (
                  <option key={key.key} value={key.key}>
                    {key.key}
                  </option>
                ))}
              </select>

              <label htmlFor="value" className="sr-only">Valor</label>
              <input
                className="border rounded p-2 w-full"
                type="text" name="value" placeholder="Valor" />

              <button
                className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
                type="submit"
              >
                Enviar
              </button>
            </div>
          </form>
        </div>
      ) : (
        <div className="max-w-sm p-2 mt-8 ml-4">
          <h1 className="dark:text-gray-300 font-bold py-2 px-4 rounded-lg hover:text-gray-900 border-gray-400 hover:bg-gray-600/50 text-gray-900 dark:bg-gradient-to-r dark:from-gray-400/80 dark:via-gray-600 dark:to-purple-200/50 border-2 dark:border-sky-200 dark:hover:bg-sky-900 hover:animate-pulse transform hover:-translate-y-1 hover:scale-110 mt-2 mb-5 bg-gradient-to-r from-gray-200 via-gray-100 to-purple-300/30 text-center transition duration-500 ease-in-out transform hover:-translate-y-1 hover:scale-110 border-2 drop-shadow-[0_10px_10px_rgba(10,15,17,0.75)] dark:drop-shadow-[0_10px_10px_rgba(255,255,255,0.25)]">
            Editor de Pedidos Woocommerce
          </h1>

          <form onSubmit={handleSubmit} >
            <div className="w-full flex flex-col justify-center gap-4">
              <label htmlFor="id" className="sr-only">ID</label>
              <input
                className="border rounded p-2 w-full"
                type="text"
                name="id"
                placeholder="ID"
              />

              <label htmlFor="store" className="sr-only">Tienda</label>
              <select
                className="border rounded p-2 w-full"
                name="store"
                value={store}
                onChange={handleStoreChange}
              >
                <option value="Ventus">VENTUS</option>
                <option value="BLK">BLANIK</option>
                <option value="BBQ">BBQGRILL</option>
              </select>

              <button
                className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
                type="submit"
              >
                Enviar
              </button>
            </div>
          </form>
        </div>
      )}

      {showTable && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div className="fixed inset-0 bg-black opacity-50"></div> {/* Fondo con backdrop */}
          <div className="bg-white dark:bg-gray-800 max-w-lg p-6 rounded-lg shadow-lg relative">
            <button className="absolute top-1 right-1 font-bolt text-2xl text-gray-500 dark:text-gray-200" onClick={toggleTable}>
              &times;
            </button>
            <h1 className="dark:text-gray-300 font-bold py-2 px-4 rounded-lg hover:text-gray-900 border-gray-400 hover:bg-gray-600/50 text-gray-900 dark:bg-gradient-to-r dark:from-gray-400/80 dark:via-gray-600 dark:to-purple-200/50 border-2 dark:border-sky-200 dark:hover:bg-sky-900 hover:animate-pulse transform hover:-translate-y-1 hover:scale-110 mt-2 mb-5 bg-gradient-to-r from-gray-200 via-gray-100 to-purple-300/30 text-center transition duration-500 ease-in-out transform hover:-translate-y-1 hover:scale-110 border-2 drop-shadow-[0_10px_10px_rgba(10,15,17,0.75)] dark:drop-shadow-[0_10px_10px_rgba(255,255,255,0.25)]">
              Información del pedido:
            </h1>
            <table className="max-w-lg bg-gray-300 dark:bg-gray-800">
              <thead>
                <tr>
                  <th className="border">Clave</th>
                  <th className="border">Valor</th>
                </tr>
              </thead>
              <tbody>
                {keys
                  .filter((k) => cleanNestedKeys(orderData, k.key) !== null)
                  .map((k) => (
                    <tr key={k.key}>
                      <td className="border text-gray-800 dark:text-white">{k.key}</td>
                      <td className="border text-gray-800 dark:text-white">{JSON.stringify(cleanNestedKeys(orderData, k.key))}</td>
                    </tr>
                  ))}
                {Object.entries(filteredOrderData).map(([key, value]) => (
                  <tr key={key}>
                    <td className="border text-gray-800 dark:text-white">{key}</td>
                    <td className="border text-gray-800 dark:text-white">{JSON.stringify(value)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

    </>
  );
};

export default SelectComponent;


